# 实现说明：数据库模型与迁移（基于 数据库设计.md）

## 1. 技术栈对齐说明

文档中描述的是通用数据库表设计，并在需求中提到了 “Eloquent 模型/迁移”。本仓库后端实际为 **Spring Boot 3 + Spring Data JPA**（见 [pom.xml](file:///d:/%E5%A4%A7%E5%AD%A6%E5%B0%B1%E4%B8%9A%E6%8C%87%E5%AF%BC/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/%E9%A1%B9%E7%9B%AE%E8%90%BD%E5%9C%B0%EF%BC%88%E5%85%A8%E6%A0%88%EF%BC%89/%E4%BC%A0%E6%99%BA%E6%9D%AF%E9%A1%B9%E7%9B%AE/backend/pom.xml)），因此本次交付采用：

- JPA 实体类（Entity）作为“模型”
- Flyway SQL 迁移文件作为“迁移”

## 2. 迁移文件

迁移脚本位于：`src/main/resources/db/migration/`

按文档的每张表分别生成：

- V1__create_users.sql
- V2__create_projects.sql
- V3__create_project_members.sql
- V4__create_project_modules.sql
- V5__create_project_files.sql
- V6__create_project_checklists.sql
- V7__create_chat_sessions.sql
- V8__create_chat_messages.sql
- V9__create_community_posts.sql
- V10__create_comments.sql

## 3. 模型（JPA Entity）

实体类位于：`src/main/java/com/ideaspark/project/model/entity/`

覆盖文档所有表：

- User（users）
- Project（projects）
- ProjectMember（project_members）
- ProjectModule（project_modules）
- ProjectFile（project_files）
- ProjectChecklist（project_checklists）
- ChatSession（chat_sessions）
- ChatMessage（chat_messages）
- CommunityPost（community_posts）
- Comment（comments）

### 关系映射

实体关系按 ER 图实现，例如：

- User 1..n Project（owner）
- Project 1..n ProjectMember
- ChatSession 1..n ChatMessage
- CommunityPost 1..n Comment
- Comment n..1 Comment（parent/replies）

### UUID 主键策略

文档要求主键为 `VARCHAR(36)`（UUID），实体使用 `@PrePersist` 生成 `UUID.randomUUID().toString()`，确保与表结构一致且不依赖数据库自增。

## 4. 配置调整

为避免 Hibernate 自动建表干扰迁移，已将：

- `spring.jpa.hibernate.ddl-auto` 调整为 `none`
- 启用 `spring.flyway.enabled=true`

对应文件：

- [application.yml](file:///d:/%E5%A4%A7%E5%AD%A6%E5%B0%B1%E4%B8%9A%E6%8C%87%E5%AF%BC/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/%E9%A1%B9%E7%9B%AE%E8%90%BD%E5%9C%B0%EF%BC%88%E5%85%A8%E6%A0%88%EF%BC%89/%E4%BC%A0%E6%99%BA%E6%9D%AF%E9%A1%B9%E7%9B%AE/backend/src/main/resources/application.yml)
- [test application.yml](file:///d:/%E5%A4%A7%E5%AD%A6%E5%B0%B1%E4%B8%9A%E6%8C%87%E5%AF%BC/%E9%A1%B9%E7%9B%AE%E7%9B%B8%E5%85%B3/%E9%A1%B9%E7%9B%AE%E8%90%BD%E5%9C%B0%EF%BC%88%E5%85%A8%E6%A0%88%EF%BC%89/%E4%BC%A0%E6%99%BA%E6%9D%AF%E9%A1%B9%E7%9B%AE/backend/src/test/resources/application.yml)

## 5. 测试用例

新增测试：

- SchemaMigrationTests：启动 Spring 上下文后，使用 JdbcTemplate 对所有表执行 `SELECT COUNT(*)`，用于验证 Flyway 迁移已生效并创建完整结构。

